<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DatGPT - Chat & Live Voice</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');

        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --accent: #38bdf8;
            --text: #ffffff;
        }

        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* HEADER */
        header { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; background: #0f172a; z-index: 10; }
        .brand { font-weight: 700; font-size: 18px; color: var(--accent); }

        /* CHAT UI (TEXT) */
        #chat-interface { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { max-width: 85%; padding: 10px 15px; border-radius: 18px; font-size: 15px; line-height: 1.5; }
        .user { align-self: flex-end; background: var(--accent); color: #000; border-bottom-right-radius: 4px; }
        .ai { align-self: flex-start; background: var(--card); border: 1px solid rgba(255,255,255,0.1); border-bottom-left-radius: 4px; }

        .input-zone { padding: 15px; background: var(--bg); border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px; }
        textarea { flex: 1; background: var(--card); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 10px; border-radius: 20px; resize: none; height: 45px; }
        
        /* Buttons */
        .btn { border: none; border-radius: 12px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-send { width: 45px; background: var(--accent); color: #000; }
        
        /* Nút Chế độ Live nổi bật */
        .btn-live {
            background: linear-gradient(135deg, #ef4444, #f43f5e);
            color: white; padding: 0 15px; font-size: 13px; gap: 5px;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }
        .btn-live:hover { transform: scale(1.05); }

        /* VOICE LIVE OVERLAY (Full Screen) */
        #live-overlay {
            position: fixed; inset: 0; background: #020617; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.3s ease; transform: translateY(100%);
        }
        #live-overlay.active { transform: translateY(0); }

        /* Visualizer (Hiệu ứng vòng tròn) */
        .visualizer {
            width: 150px; height: 150px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 50px; position: relative; transition: 0.3s;
        }

        /* Trạng thái vòng tròn */
        .state-listening { background: var(--accent); box-shadow: 0 0 30px var(--accent); animation: breathe 2s infinite; }
        .state-speaking { background: #22c55e; box-shadow: 0 0 30px #22c55e; animation: bounce 1s infinite; }
        .state-thinking { background: #eab308; box-shadow: 0 0 30px #eab308; animation: spin 1s infinite; }

        .status-text { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: #94a3b8; }
        .live-transcript { font-size: 16px; color: white; text-align: center; max-width: 80%; opacity: 0.8; height: 60px; }

        .btn-hangup {
            margin-top: 40px; background: rgba(255, 255, 255, 0.1); 
            color: white; padding: 15px 40px; border-radius: 30px; 
            border: 1px solid rgba(255,255,255,0.2); font-size: 16px;
        }
        .btn-hangup:hover { background: #ef4444; border-color: #ef4444; }

        @keyframes breathe { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        @keyframes spin { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <div class="brand">DatGPT</div>
        <button class="btn btn-live" onclick="startLiveMode()">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
            Chế độ Live
        </button>
    </header>

    <div id="chat-interface">
        <div id="chat-area"></div>
        <div class="input-zone">
            <textarea id="inp" placeholder="Nhắn tin (Flash Lite)..."></textarea>
            <button class="btn btn-send" onclick="handleChat()">➤</button>
        </div>
    </div>

    <div id="live-overlay">
        <div class="visualizer state-listening" id="viz">
            <svg id="icon-mic" width="50" height="50" fill="black" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
        </div>
        <div class="status-text" id="status">Đang nghe...</div>
        <div class="live-transcript" id="transcript"></div>
        <button class="btn btn-hangup" onclick="endLiveMode()">Kết thúc cuộc gọi</button>
    </div>

    <script>
        // === CẤU HÌNH ===
        const CONFIG = {
            apiKey: "AIzaSyA7YEavMh6_c2qvvw1oMgChgXwzh-KsFDo", 
            
            // Model Chat thường
            chatModel: "gemini-2.5-flash-lite", 
            
            // Model Voice Live
            voiceModel: "gemini-2.5-flash-native-audio" 
        };

        let history = [];
        let recognition;
        let isLiveActive = false;

        // --- 1. XỬ LÝ CHAT THƯỜNG (TEXT) ---
        async function handleChat() {
            const inp = document.getElementById('inp');
            const text = inp.value.trim();
            if(!text) return;

            addBubble('user', text);
            inp.value = '';

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.chatModel}:generateContent?key=${CONFIG.apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [...history, { role: "user", parts: [{ text }] }]
                    })
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;
                
                addBubble('ai', reply);
                history.push({role: "user", parts: [{text}]});
                history.push({role: "model", parts: [{text: reply}]});
            } catch(e) {
                addBubble('ai', "Lỗi kết nối hoặc tên model chưa đúng.");
            }
        }

        function addBubble(role, text) {
            const area = document.getElementById('chat-area');
            area.innerHTML += `<div class="msg ${role}">${marked.parse(text)}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        // --- 2. XỬ LÝ LIVE VOICE (REAL-TIME) ---
        
        function setupVoice() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.lang = 'vi-VN';
                recognition.continuous = false; 
                recognition.interimResults = false;

                recognition.onstart = () => updateLiveUI('listening');
                
                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    document.getElementById('transcript').innerText = `"${text}"`;
                    processLiveQuery(text); // Gửi đi xử lý ngay
                };

                recognition.onend = () => {
                    // Nếu đang Live mà mic tắt (do im lặng), và AI chưa nói -> Bật lại mic ngay
                    if (isLiveActive && document.getElementById('status').innerText !== 'AI đang nói...') {
                         try { recognition.start(); } catch(e) {}
                    }
                };
            } else {
                alert("Trình duyệt không hỗ trợ Web Speech API");
            }
        }

        // Logic gửi API cho Voice Mode
        async function processLiveQuery(text) {
            updateLiveUI('thinking');
            
            try {
                // Dùng model Native Audio cho Voice
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.voiceModel}:generateContent?key=${CONFIG.apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [
                            { role: "user", parts: [{ text: "System: Trả lời ngắn gọn như đang nói chuyện trực tiếp." }] },
                            ...history, 
                            { role: "user", parts: [{ text }] } 
                        ]
                    })
                });

                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;

                // Cập nhật history chung
                history.push({role: "user", parts: [{text}]});
                history.push({role: "model", parts: [{text: reply}]});

                // Đọc to câu trả lời
                speakLive(reply);

            } catch (e) {
                speakLive("Xin lỗi, tôi bị mất kết nối.");
            }
        }

        // Text-to-Speech và Vòng lặp
        function speakLive(text) {
            updateLiveUI('speaking');
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'vi-VN';
            utterance.rate = 1.1;

            utterance.onend = () => {
                // QUAN TRỌNG: AI nói xong -> Bật lại mic ngay lập tức
                if (isLiveActive) {
                    updateLiveUI('listening');
                    setTimeout(() => { try { recognition.start(); } catch(e){} }, 300);
                }
            };

            window.speechSynthesis.speak(utterance);
        }

        // --- 3. ĐIỀU KHIỂN GIAO DIỆN ---

        function startLiveMode() {
            isLiveActive = true;
            document.getElementById('live-overlay').classList.add('active');
            setupVoice();
            try { recognition.start(); } catch(e) {}
        }

        function endLiveMode() {
            isLiveActive = false;
            document.getElementById('live-overlay').classList.remove('active');
            window.speechSynthesis.cancel();
            try { recognition.stop(); } catch(e) {}
        }

        function updateLiveUI(state) {
            const viz = document.getElementById('viz');
            const status = document.getElementById('status');
            
            // Reset class
            viz.className = 'visualizer';
            
            if (state === 'listening') {
                viz.classList.add('state-listening');
                status.innerText = "Đang nghe bạn...";
            } else if (state === 'thinking') {
                viz.classList.add('state-thinking');
                status.innerText = "Đang suy nghĩ...";
            } else if (state === 'speaking') {
                viz.classList.add('state-speaking');
                status.innerText = "AI đang nói...";
            }
        }
        
        // Enter để chat
        document.getElementById('inp').onkeydown = (e) => { if(e.key === 'Enter') handleChat(); }

    </script>
</body>
</html>
