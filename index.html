<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DatGPT 1.7</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400&display=swap');

        :root {
            --bg-body: #09090b; /* M√†u ƒëen s√¢u */
            --bg-panel: #18181b; /* M√†u x√°m ƒëen panel */
            --border: #27272a;
            --primary: #10a37f; /* Xanh ChatGPT */
            --primary-hover: #0d8a6b;
            --text-main: #e4e4e7;
            --text-sub: #a1a1aa;
            
            --color-research: #8b5cf6; /* T√≠m */
            --color-web: #3b82f6; /* Xanh d∆∞∆°ng */
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh; height: 100dvh;
            overflow: hidden;
            font-size: 15px;
        }

        /* ICON SVG STYLES */
        svg { width: 20px; height: 20px; stroke-width: 1.5; }
        .icon-sm { width: 16px; height: 16px; }

        #app-container {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            max-width: 1200px; margin: 0 auto; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông tr√™n m√†n to */
            background: var(--bg-body);
        }

        /* === HEADER === */
        header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-body);
        }
        .app-branding { display: flex; align-items: center; gap: 10px; }
        .status-dot { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 10px var(--primary); }
        .app-name { font-weight: 600; font-size: 16px; letter-spacing: -0.5px; }
        .version-tag { font-size: 11px; background: #27272a; padding: 2px 6px; border-radius: 4px; color: #888; }

        /* === CHAT AREA === */
        #chat-area {
            flex: 1; overflow-y: auto;
            padding: 20px;
            display: flex; flex-direction: column; gap: 25px;
            scroll-behavior: smooth;
        }

        .msg-row { display: flex; gap: 15px; width: 100%; }
        .msg-row.user { justify-content: flex-end; }
        
        .avatar {
            width: 32px; height: 32px; border-radius: 6px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .avatar.ai { background: #10a37f; }
        .avatar.user { background: #555; display: none; } /* ·∫®n avatar user cho g·ªçn */

        .msg-content {
            max-width: 800px;
            line-height: 1.6;
            font-size: 15px;
        }
        
        .msg-row.user .msg-content {
            background: #27272a;
            padding: 10px 15px;
            border-radius: 12px;
            color: #fff;
        }
        
        .msg-row.ai .msg-content {
            background: transparent;
            padding: 0;
            width: 100%;
        }

        /* Sources Box (Web Search) */
        .sources-container {
            margin-top: 15px; margin-bottom: 15px;
            display: flex; gap: 10px; flex-wrap: wrap;
        }
        .source-chip {
            background: #1e1e24; border: 1px solid #333; padding: 8px 12px;
            border-radius: 8px; font-size: 12px; color: #aaa; text-decoration: none;
            display: flex; align-items: center; gap: 6px; transition: 0.2s; max-width: 200px;
        }
        .source-chip:hover { border-color: var(--color-web); color: #fff; }
        .source-chip span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        pre { background: #18181b !important; padding: 15px; border-radius: 8px; overflow-x: auto; margin: 15px 0; border: 1px solid #333; }
        code { font-family: 'JetBrains Mono', monospace; font-size: 13px; }
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid #333; }

        /* === INPUT AREA === */
        .input-container {
            padding: 20px;
            background: var(--bg-body);
            display: flex; flex-direction: column; gap: 12px;
        }

        /* Tools Row */
        .tools-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; align-items: center; }
        .tools-row::-webkit-scrollbar { display: none; }

        .btn-pill {
            background: #18181b; border: 1px solid #333; color: var(--text-sub);
            padding: 6px 12px; border-radius: 8px; font-size: 13px; cursor: pointer;
            display: flex; align-items: center; gap: 6px; transition: 0.2s;
            user-select: none;
        }
        .btn-pill:hover { background: #27272a; color: #fff; }
        
        /* Toggle States */
        .btn-pill.active-deep { background: rgba(139, 92, 246, 0.15); border-color: var(--color-research); color: var(--color-research); }
        .btn-pill.active-web { background: rgba(59, 130, 246, 0.15); border-color: var(--color-web); color: var(--color-web); }
        .btn-pill.action-red:hover { color: #ef4444; border-color: #ef4444; }

        /* Main Input Box */
        .input-box {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px 12px;
            display: flex; align-items: flex-end; gap: 10px;
            transition: 0.2s;
        }
        .input-box:focus-within { border-color: #555; }

        textarea {
            flex: 1; background: transparent; border: none; color: #fff;
            padding: 10px 0; resize: none; height: 44px; max-height: 150px;
            font-family: inherit; font-size: 15px; line-height: 1.5;
        }

        .btn-icon {
            width: 36px; height: 36px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; background: transparent; border: none; color: #888;
            transition: 0.2s; flex-shrink: 0;
        }
        .btn-icon:hover { background: #27272a; color: #fff; }
        
        .btn-send {
            background: var(--primary); color: #fff; border-radius: 8px;
        }
        .btn-send:hover { background: var(--primary-hover); }

        .btn-mic.listening { color: #ef4444; background: rgba(239, 68, 68, 0.1); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* Preview Image */
        .preview-box { display: none; margin-left: 10px; position: relative; }
        .preview-box img { height: 40px; border-radius: 4px; border: 1px solid #444; }
        .preview-box .btn-close { position: absolute; top: -5px; right: -5px; width: 16px; height: 16px; background: #333; border-radius: 50%; color: #fff; font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* Modal */
        #settings-modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 999;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: #18181b; width: 400px; padding: 25px; border-radius: 12px;
            border: 1px solid #333;
        }
        .input-group label { display: block; color: #888; font-size: 13px; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 10px; background: #27272a; border: 1px solid #333; color: white; border-radius: 6px; }
        
        /* Mobile */
        @media screen and (max-width: 768px) {
            .app-name { font-size: 15px; }
            .btn-pill span { display: none; } /* ·∫®n ch·ªØ tr√™n mobile cho g·ªçn */
            .btn-pill svg { margin: 0; }
            .input-container { padding: 15px 10px; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <div class="app-branding">
                <span class="status-dot"></span>
                <span class="app-name">DatGPT</span>
                <span class="version-tag">PRO 1.7</span>
            </div>
            <button class="btn-icon" onclick="toggleSettings()" title="C√†i ƒë·∫∑t">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </button>
        </header>

        <div id="chat-area">
            <div class="msg-row ai">
                <div class="avatar ai">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="width:18px;height:18px"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 14a4 4 0 1 1 4-4 4 4 0 0 1-4 4z"></path></svg>
                </div>
                <div class="msg-content">
                    <b>Ch√†o b·∫°n!</b> T√¥i ch·∫°y model 2.5 flash.<br>
                    T√¥i h·ªó tr·ª£ 2 ch·∫ø ƒë·ªô m·∫°nh m·∫Ω (C√≥ th·ªÉ b·∫≠t c·∫£ hai):<br>
                    1. <b>üåè Web Search:</b> T√¨m ki·∫øm th√¥ng tin th·ª±c t·∫ø t·ª´ Google.<br>
                    2. <b>üß† Deep Research:</b> Ph√¢n t√≠ch chuy√™n s√¢u v√† logic.
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="tools-row">
                <div class="btn-pill" id="btnWeb" onclick="toggleMode('web')">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    <span>Web Search</span>
                </div>
                <div class="btn-pill" id="btnDeep" onclick="toggleMode('deep')">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                    <span>Deep Research</span>
                </div>

                <div style="flex:1"></div> <div class="btn-pill action-red" onclick="clearChat()" title="X√≥a Chat">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </div>
                <div class="btn-pill" onclick="exportChat()" title="L∆∞u Chat">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                </div>
            </div>

            <div class="input-box">
                <div class="preview-box" id="preview-box">
                    <img id="preview-img" src="">
                    <div class="btn-close" onclick="removeImg()">√ó</div>
                </div>

                <button class="btn-icon" id="btnLive" title="Live Mode (H·ªôi tho·∫°i)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 18v-6a9 9 0 0 1 18 0v6"></path><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path></svg>
                </button>
                <button class="btn-icon btn-mic" id="btnMic" title="Nh·∫≠p gi·ªçng n√≥i">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                </button>

                <textarea id="userInput" placeholder="Nh·∫≠p tin nh·∫Øn..." rows="1" oninput="autoResize(this)"></textarea>

                <button class="btn-icon btn-send" id="btnSend">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="stroke-width:2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal-box">
            <h3 style="margin-top:0; color:#fff;">C√†i ƒë·∫∑t</h3>
            <div class="input-group">
                <label>T√™n hi·ªÉn th·ªã</label>
                <input type="text" id="cfgName" placeholder="B·∫°n">
            </div>
            <div class="input-group" style="margin-top:15px">
                <label>Gemini API Key <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--primary); float:right">(L·∫•y Key m·ªõi)</a></label>
                <input type="password" id="cfgKey" placeholder="Paste Key v√†o ƒë√¢y...">
            </div>
            <button onclick="saveSettings()" style="width:100%; background:var(--primary); color:white; padding:12px; border-radius:6px; border:none; margin-top:15px; cursor:pointer; font-weight:600">L∆∞u C·∫•u H√¨nh</button>
            <button onclick="toggleSettings()" style="width:100%; background:transparent; color:#888; padding:10px; border:none; margin-top:5px; cursor:pointer;">ƒê√≥ng</button>
        </div>
    </div>

    <script>
        // === CONFIG ===
        const CONFIG = { modelId: "gemini-2.5-flash", historyLimit: 20 };
        let state = {
            apiKey: localStorage.getItem('gpt_key') || "",
            userName: localStorage.getItem('gpt_name') || "B·∫°n",
            history: [],
            isLive: false,
            aiSpeaking: false,
            // 2 Ch·∫ø ƒë·ªô ri√™ng bi·ªát
            isWeb: false,
            isDeep: false
        };

        const chatArea = document.getElementById('chat-area');
        const userInput = document.getElementById('userInput');
        let imgBase64 = null;

        marked.setOptions({ breaks: true, highlight: (code) => hljs.highlightAuto(code).value });
        if(!state.apiKey) setTimeout(toggleSettings, 800);

        // === TOGGLE MODES ===
        function toggleMode(mode) {
            if (mode === 'web') {
                state.isWeb = !state.isWeb;
                document.getElementById('btnWeb').classList.toggle('active-web', state.isWeb);
            }
            if (mode === 'deep') {
                state.isDeep = !state.isDeep;
                document.getElementById('btnDeep').classList.toggle('active-deep', state.isDeep);
            }
        }

        // === CORE LOGIC ===
        async function sendMsg() {
            const text = userInput.value.trim();
            if(!text && !imgBase64) return;
            if(!state.apiKey) { toggleSettings(); return; }

            // UI User
            addMsg('user', text || '[G·ª≠i h√¨nh ·∫£nh]', !!imgBase64);
            if(imgBase64) addMsg('user', `<img src="data:image/png;base64,${imgBase64}">`, true);
            
            userInput.value = ''; userInput.style.height = '44px';
            removeImg();
            
            // UI Loading Status
            let statusText = '...';
            if (state.isWeb && state.isDeep) statusText = 'üåè ƒêang t√¨m ki·∫øm & üß† Suy lu·∫≠n s√¢u...';
            else if (state.isWeb) statusText = 'üåè ƒêang t√¨m ki·∫øm tr√™n Google...';
            else if (state.isDeep) statusText = 'üß† ƒêang ph√¢n t√≠ch chuy√™n s√¢u...';

            const loadingRow = addMsg('ai', `<span style="color:#888; font-style:italic">${statusText}</span>`, true);
            const contentDiv = loadingRow.querySelector('.msg-content');

            // Construct System Prompt
            let sysText = `B·∫°n l√† DatGPT Pro. T√™n User: ${state.userName}. `;
            if (state.isDeep) {
                sysText += `[CH·∫æ ƒê·ªò DEEP RESEARCH]: Tr·∫£ l·ªùi c·ª±c k·ª≥ chi ti·∫øt, c√≥ c·∫•u tr√∫c (M·ªü b√†i, Lu·∫≠n ƒëi·ªÉm, D·∫´n ch·ª©ng, K·∫øt lu·∫≠n). D√πng gi·ªçng vƒÉn chuy√™n gia. `;
            } else {
                sysText += `Tr·∫£ l·ªùi ng·∫Øn g·ªçn, h·ªØu √≠ch, format ƒë·∫πp. `;
            }
            if (state.isWeb) {
                sysText += `[CH·∫æ ƒê·ªò WEB SEARCH]: B·∫°n c√≥ quy·ªÅn truy c·∫≠p c√¥ng c·ª• t√¨m ki·∫øm Google. H√£y d√πng n√≥ ƒë·ªÉ l·∫•y th√¥ng tin m·ªõi nh·∫•t. Lu√¥n tr√≠ch d·∫´n ngu·ªìn. `;
            }

            // Construct Payload with Tools
            let payload = {
                contents: [
                    ...state.history.slice(-CONFIG.historyLimit),
                    { role: 'user', parts: imgBase64 ? [{ inlineData: { mimeType: "image/png", data: imgBase64 }}, { text }] : [{ text }] }
                ],
                systemInstruction: { parts: [{ text: sysText }] }
            };

            // Add Google Search Tool if Web Mode is ON
            if (state.isWeb) {
                payload.tools = [{ google_search: {} }];
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.modelId}:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                
                // Parse Response
                const candidate = data.candidates[0];
                let reply = candidate.content.parts[0].text;
                
                // Handle Grounding (Web Sources)
                let sourcesHtml = '';
                if (candidate.groundingMetadata && candidate.groundingMetadata.groundingChunks) {
                    sourcesHtml = `<div class="sources-container">`;
                    candidate.groundingMetadata.groundingChunks.forEach(chunk => {
                        if (chunk.web && chunk.web.uri) {
                            sourcesHtml += `<a href="${chunk.web.uri}" target="_blank" class="source-chip">üîó <span>${chunk.web.title || 'Ngu·ªìn tin'}</span></a>`;
                        }
                    });
                    sourcesHtml += `</div>`;
                }

                contentDiv.innerHTML = marked.parse(reply) + sourcesHtml;
                
                // Copy Code Btn
                contentDiv.querySelectorAll('pre code').forEach(block => {
                    const btn = document.createElement('button');
                    btn.innerText = 'Copy';
                    btn.style.cssText = 'position:absolute; top:10px; right:10px; background:#333; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;';
                    btn.onclick = () => navigator.clipboard.writeText(block.innerText);
                    block.parentElement.style.position = 'relative';
                    block.parentElement.appendChild(btn);
                });

                // Update History
                state.history.push(
                    { role: 'user', parts: [{ text: text || 'Image' }] },
                    { role: 'model', parts: [{ text: reply }] }
                );

                speak(reply);

            } catch (error) {
                contentDiv.innerHTML = `<span style="color:#ef4444">‚ö†Ô∏è L·ªói: ${error.message}<br><small>N·∫øu l·ªói Web Search, h√£y ƒë·∫£m b·∫£o API Key c·ªßa b·∫°n h·ªó tr·ª£ t√≠nh nƒÉng n√†y.</small></span>`;
            }
        }

        function addMsg(role, text, isHtml) {
            const row = document.createElement('div');
            row.className = `msg-row ${role}`;
            row.innerHTML = `
                ${role === 'ai' ? `<div class="avatar ai"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="width:18px;height:18px"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 14a4 4 0 1 1 4-4 4 4 0 0 1-4 4z"></path></svg></div>` : ''}
                <div class="msg-content">${isHtml ? text : marked.parse(text)}</div>
            `;
            chatArea.appendChild(row);
            chatArea.scrollTop = chatArea.scrollHeight;
            return row;
        }

        // === UTILS ===
        function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
        function toggleSettings() {
            const m = document.getElementById('settings-modal');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
            if(m.style.display==='flex') { document.getElementById('cfgName').value=state.userName; document.getElementById('cfgKey').value=state.apiKey; }
        }
        function saveSettings() {
            const k=document.getElementById('cfgKey').value.trim(); const n=document.getElementById('cfgName').value.trim();
            if(k) { localStorage.setItem('gpt_key', k); state.apiKey = k; }
            if(n) { localStorage.setItem('gpt_name', n); state.userName = n; }
            toggleSettings();
        }
        function clearChat() { chatArea.innerHTML = ''; state.history = []; }
        function exportChat() {
            const blob = new Blob([state.history.map(m => `### ${m.role}:\n${m.parts[0].text}`).join('\n\n')], {type:'text/markdown'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='Chat.md'; a.click();
        }

        window.addEventListener('paste', e => {
            const item = Array.from(e.clipboardData.items).find(i => i.type.includes('image'));
            if(item) {
                const r = new FileReader();
                r.onload = (ev) => { imgBase64 = ev.target.result.split(',')[1]; document.getElementById('preview-img').src = ev.target.result; document.getElementById('preview-box').style.display = 'block'; };
                r.readAsDataURL(item.getAsFile());
            }
        });
        function removeImg() { imgBase64 = null; document.getElementById('preview-box').style.display = 'none'; }
        
        document.getElementById('btnSend').onclick = sendMsg;
        userInput.addEventListener('keypress', e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }});

        // Voice
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if(SpeechRecognition) {
            recognition = new SpeechRecognition(); recognition.lang = 'vi-VN'; recognition.continuous = false;
            recognition.onstart = () => { document.getElementById('btnMic').classList.add('listening'); if(state.isLive) document.getElementById('btnLive').style.color='#ef4444'; };
            recognition.onend = () => { document.getElementById('btnMic').classList.remove('listening'); if(state.isLive && !state.aiSpeaking) setTimeout(()=>recognition.start(), 500); };
            recognition.onresult = (e) => { const t = e.results[0][0].transcript; if(state.isLive){ userInput.value=t; sendMsg(); } else { userInput.value += (userInput.value?' ':'')+t; autoResize(userInput); } };
        }
        document.getElementById('btnMic').onclick = () => recognition && recognition.start();
        document.getElementById('btnLive').onclick = function() {
            if(!recognition) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£");
            state.isLive = !state.isLive;
            this.style.color = state.isLive ? '#ef4444' : '#888';
            state.isLive ? recognition.start() : (recognition.stop(), window.speechSynthesis.cancel());
        };
        function speak(text) {
            if(!state.isLive) return;
            window.speechSynthesis.cancel(); state.aiSpeaking = true; recognition.stop();
            const u = new SpeechSynthesisUtterance(text.replace(/[*#`]/g, '').substring(0,300)); u.lang='vi-VN';
            u.onend = () => { state.aiSpeaking = false; if(state.isLive) setTimeout(()=>recognition.start(), 500); };
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
