<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DatGPT 4.0</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400&display=swap');

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background-color: #1e1e1e;
            color: #eee;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            font-size: 14px; /* Gi·∫£m font base */
        }

        #app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            position: relative;
        }

        /* Header g·ªçn h∆°n */
        header {
            padding: 10px 20px;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            height: 50px;
        }
        .app-title { font-size: 15px; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; background: #00ff88; border-radius: 50%; box-shadow: 0 0 8px #00ff88; }
        .live-badge { font-size: 10px; background: #e74c3c; color: white; padding: 2px 5px; border-radius: 3px; display: none; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.6; } }

        /* V√πng Chat */
        #chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 15px 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
            align-items: center;
        }

        .msg-row {
            width: 100%;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
        }
        .msg-row.user { align-items: flex-end; }
        .msg-row.ai { align-items: flex-start; }

        .msg {
            max-width: 750px;
            width: fit-content;
            padding: 8px 14px; /* Gi·∫£m padding */
            border-radius: 8px;
            line-height: 1.5;
            font-size: 14.5px; /* Font ch·ªØ v·ª´a ph·∫£i */
            word-wrap: break-word;
            position: relative;
        }
        
        .msg.user { background: #10a37f; color: #fff; border-bottom-right-radius: 2px; }
        .msg.ai { background: #2f2f2f; border: 1px solid #444; border-bottom-left-radius: 2px; width: 100%; max-width: 750px; }
        
        pre { background: #111 !important; padding: 10px; border-radius: 6px; overflow-x: auto; margin: 8px 0; border: 1px solid #444; }
        code { font-family: 'JetBrains Mono', monospace; font-size: 13px; }
        .msg img { max-width: 100%; height: auto; border-radius: 6px; margin-top: 8px; border: 1px solid #555; }

        /* Input Area G·ªçn g√†ng */
        .input-container {
            padding: 15px 20px;
            background: #1e1e1e;
            border-top: 1px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
        }

        .input-wrapper {
            width: 100%;
            max-width: 800px;
        }
        
        .preview-box { display: none; margin-bottom: 8px; }
        .preview-box img { height: 50px; border-radius: 4px; border: 1px solid #555; }
        .preview-box span { color: #ff5555; cursor: pointer; font-size: 18px; margin-left: 10px; vertical-align: top; }

        .input-row { display: flex; gap: 10px; align-items: flex-end; width: 100%; }
        
        textarea {
            flex: 1;
            background: #2a2a2a;
            border: 1px solid #444;
            color: #fff;
            padding: 10px 12px;
            border-radius: 6px;
            resize: none;
            height: 42px; /* Chi·ªÅu cao nh·ªè g·ªçn */
            outline: none;
            font-family: inherit;
            font-size: 14px;
            transition: 0.2s;
        }
        textarea:focus { border-color: #10a37f; background: #252525; }

        /* N√∫t b·∫•m nh·ªè h∆°n */
        button {
            height: 42px; width: 42px;
            border: none; border-radius: 6px;
            cursor: pointer; font-size: 18px;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
            flex-shrink: 0;
        }
        .btn-mic { background: #333; color: #fff; border: 1px solid #444; }
        .btn-mic:hover { background: #444; }
        .btn-mic.listening { background: #e74c3c; border-color: #c0392b; animation: pulse 1.5s infinite; }
        
        .btn-send { background: #10a37f; color: white; }
        .btn-send:hover { background: #0e8c6d; }

        /* Tools Pill nh·ªè h∆°n */
        .tools { display: flex; gap: 8px; margin-bottom: 8px; overflow-x: auto; padding-bottom: 2px; width: 100%; justify-content: flex-start; }
        .tools::-webkit-scrollbar { height: 2px; }
        .pill { background: #2a2a2a; border: 1px solid #333; color: #ccc; padding: 4px 10px; border-radius: 15px; font-size: 12px; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .pill:hover { border-color: #10a37f; color: #fff; background: #333; }

        /* Settings Modal */
        #settings-modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        .modal-box {
            background: #222; width: 380px; max-width: 100%; padding: 20px; border-radius: 10px;
            border: 1px solid #444; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .modal-title { margin-top: 0; color: #fff; font-size: 18px; margin-bottom: 15px; }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; color: #aaa; font-size: 13px; margin-bottom: 4px; }
        
        /* Link l·∫•y API Key */
        .api-link { color: #10a37f; text-decoration: none; font-weight: 600; margin-left: 5px; cursor: pointer; }
        .api-link:hover { text-decoration: underline; }

        .input-group input { width: 100%; padding: 8px; background: #333; border: 1px solid #555; color: white; border-radius: 5px; font-size: 13px; }
        .btn-save { width: 100%; background: #10a37f; color: white; padding: 8px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Mobile Adjustments */
        @media screen and (max-width: 768px) {
            header { padding: 8px 15px; }
            .msg { max-width: 95%; font-size: 14px; }
            .input-container { padding: 10px; }
            .input-row { gap: 8px; }
            button { width: 40px; height: 40px; }
            textarea { height: 40px; font-size: 14px; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <div class="app-title">
                <span class="status-dot"></span> 
                DatGPT 4.0
                <span class="live-badge" id="live-badge">‚óè LIVE</span>
            </div>
            <div>
                <button onclick="toggleSettings()" style="width:auto; height:auto; background:none; border:none; color:#aaa; font-size:13px; padding:5px; cursor:pointer">‚öôÔ∏è C√†i ƒë·∫∑t</button>
            </div>
        </header>

        <div id="chat-area">
            <div class="msg-row ai">
                <div class="msg ai">
                    üëã <b>Ch√†o b·∫°n!</b><br>
                    T√¥i s·ª≠ d·ª•ng model <b>Gemini 2.5 Flash</b> ƒë√≥ hihi.<br>
                    b·∫°n h√£y h·ªèi g√¨ ƒëi
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <div class="tools">
                    <span class="pill" onclick="clearChat()">üßπ X√≥a</span>
                    <span class="pill" onclick="setInput('Vi·∫øt code Python ƒë·ªÉ')">üêç Python</span>
                    <span class="pill" onclick="setInput('D·ªãch sang ti·∫øng vi·ªát: ')">D·ªãch</span>
                    <span class="pill" onclick="exportChat()">üíæ L∆∞u</span>
                </div>

                <div class="preview-box" id="preview-box">
                    <img id="preview-img" src="">
                    <span onclick="removeImg()">√ó</span>
                </div>

                <div class="input-row">
                    <button class="btn-mic" id="btnLive" title="Ch·∫ø ƒë·ªô H·ªôi tho·∫°i li√™n t·ª•c">üéß</button>
                    <button class="btn-mic" id="btnMic" title="Nh·∫≠p gi·ªçng n√≥i">üéôÔ∏è</button>
                    <textarea id="userInput" placeholder="Nh·∫≠p tin nh·∫Øn..."></textarea>
                    <button class="btn-send" id="btnSend">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal-box">
            <h3 class="modal-title">C√†i ƒë·∫∑t</h3>
            <div class="input-group">
                <label>T√™n hi·ªÉn th·ªã:</label>
                <input type="text" id="cfgName" placeholder="V√≠ d·ª•: ƒê·∫°t">
            </div>
            <div class="input-group">
                <label>
                    Gemini API Key:
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="api-link">(L·∫•y Key t·∫°i ƒë√¢y ‚Üó)</a>
                </label>
                <input type="password" id="cfgKey" placeholder="D√°n API Key v√†o ƒë√¢y...">
            </div>
            <button class="btn-save" onclick="saveSettings()">L∆∞u & ƒê√≥ng</button>
            <button onclick="toggleSettings()" style="width:100%; margin-top:8px; background:none; border:none; color:#888; cursor:pointer; font-size:13px;">H·ªßy</button>
        </div>
    </div>

    <script>
        // === C·∫§U H√åNH ===
        // S·ª≠ d·ª•ng model Flash 2.0 Experimental (Nhanh v√† m·ªõi nh·∫•t hi·ªán t·∫°i)
        const CONFIG = { modelId: "gemini-2.0-flash-exp", historyLimit: 20 }; 
        
        let state = {
            apiKey: localStorage.getItem('gpt_key') || "",
            userName: localStorage.getItem('gpt_name') || "B·∫°n",
            history: [],
            isLive: false,
            aiSpeaking: false
        };

        const chatArea = document.getElementById('chat-area');
        const userInput = document.getElementById('userInput');
        let imgBase64 = null;

        marked.setOptions({ breaks: true, highlight: (code) => hljs.highlightAuto(code).value });
        if(!state.apiKey) setTimeout(toggleSettings, 800);

        async function sendMsg() {
            const text = userInput.value.trim();
            if(!text && !imgBase64) return;
            if(!state.apiKey) { alert("Vui l√≤ng nh·∫≠p API Key!"); toggleSettings(); return; }

            addMsg('user', text || '[H√¨nh ·∫£nh]', !!imgBase64);
            if(imgBase64) addMsg('user', `<img src="data:image/png;base64,${imgBase64}">`, true);
            
            userInput.value = '';
            removeImg();
            
            const loadingRow = addMsg('ai', '<span style="color:#888">...</span>', true);
            const loadingDiv = loadingRow.querySelector('.msg');

            let contents = state.history.slice(-CONFIG.historyLimit);
            let parts = [];
            if(imgBase64) parts.push({ inlineData: { mimeType: "image/png", data: imgBase64 }});
            parts.push({ text: text || "M√¥ t·∫£ h√¨nh n√†y" });
            contents.push({ role: 'user', parts });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.modelId}:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: contents,
                        systemInstruction: { parts: [{ text: `B·∫°n l√† tr·ª£ l√Ω ·∫£o. T√™n User: ${state.userName}. Tr·∫£ l·ªùi ng·∫Øn g·ªçn, format Code ƒë·∫πp.` }] }
                    })
                });

                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                
                const reply = data.candidates[0].content.parts[0].text;
                loadingDiv.innerHTML = marked.parse(reply);
                
                loadingDiv.querySelectorAll('pre code').forEach(block => {
                    block.parentElement.style.position = 'relative';
                    const btn = document.createElement('button');
                    btn.innerText = 'Copy';
                    btn.style.cssText = 'position:absolute; top:5px; right:5px; background:#444; color:#fff; font-size:10px; padding:2px 6px; height:auto; width:auto; border-radius:3px; margin:0;';
                    btn.onclick = () => { navigator.clipboard.writeText(block.innerText); btn.innerText = 'OK'; setTimeout(()=>btn.innerText='Copy',1500); };
                    block.parentElement.appendChild(btn);
                });

                state.history.push({ role: 'user', parts }, { role: 'model', parts: [{ text: reply }] });
                speak(reply);

            } catch (error) {
                loadingDiv.innerHTML = `<span style="color:#ff5555">L·ªói: ${error.message}</span>`;
                state.aiSpeaking = false;
            }
        }

        function addMsg(role, text, isHtml) {
            const row = document.createElement('div');
            row.className = `msg-row ${role}`;
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = isHtml ? text : marked.parse(text);
            row.appendChild(div);
            chatArea.appendChild(row);
            chatArea.scrollTop = chatArea.scrollHeight;
            return row;
        }

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
            if(modal.style.display === 'flex') {
                document.getElementById('cfgName').value = state.userName;
                document.getElementById('cfgKey').value = state.apiKey;
            }
        }

        function saveSettings() {
            const k = document.getElementById('cfgKey').value.trim();
            const n = document.getElementById('cfgName').value.trim();
            if(k) { localStorage.setItem('gpt_key', k); state.apiKey = k; }
            if(n) { localStorage.setItem('gpt_name', n); state.userName = n; }
            toggleSettings();
        }

        // --- Voice Logic (Gi·ªØ nguy√™n) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'vi-VN'; recognition.continuous = false;
            recognition.onstart = () => {
                document.getElementById('btnMic').classList.add('listening');
                if(state.isLive) document.getElementById('btnLive').classList.add('listening');
            };
            recognition.onend = () => {
                document.getElementById('btnMic').classList.remove('listening');
                if (state.isLive && !state.aiSpeaking) setTimeout(() => { try { recognition.start(); } catch(e){} }, 500);
            };
            recognition.onresult = (e) => {
                const t = e.results[0][0].transcript;
                if(state.isLive) { userInput.value = t; sendMsg(); } 
                else { userInput.value += (userInput.value ? " " : "") + t; }
            };
        }
        document.getElementById('btnMic').onclick = () => { if(state.isLive) return alert("T·∫Øt ch·∫ø ƒë·ªô Live tr∆∞·ªõc!"); recognition && recognition.start(); };
        document.getElementById('btnLive').onclick = function() {
            if(!recognition) return alert("Kh√¥ng h·ªó tr·ª£ gi·ªçng n√≥i");
            state.isLive = !state.isLive;
            document.getElementById('live-badge').style.display = state.isLive ? 'inline-block' : 'none';
            this.style.background = state.isLive ? '#e74c3c' : '#333';
            state.isLive ? recognition.start() : (recognition.stop(), window.speechSynthesis.cancel());
        };

        function speak(text) {
            if(!state.isLive) return;
            window.speechSynthesis.cancel();
            state.aiSpeaking = true; recognition.stop();
            const u = new SpeechSynthesisUtterance(text.replace(/[*#`]/g, '').substring(0, 300));
            u.lang = 'vi-VN';
            u.onend = () => { state.aiSpeaking = false; if(state.isLive) setTimeout(() => recognition.start(), 500); };
            window.speechSynthesis.speak(u);
        }

        function clearChat() { chatArea.innerHTML = ''; state.history = []; }
        function setInput(txt) { userInput.value = txt; userInput.focus(); }
        function exportChat() {
            const blob = new Blob([state.history.map(m => `### ${m.role}:\n${m.parts[0].text}`).join('\n\n')], {type: 'text/markdown'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Chat.md`; a.click();
        }
        window.addEventListener('paste', e => {
            const item = Array.from(e.clipboardData.items).find(i => i.type.includes('image'));
            if(item) {
                const r = new FileReader();
                r.onload = (ev) => { imgBase64 = ev.target.result.split(',')[1]; document.getElementById('preview-img').src = ev.target.result; document.getElementById('preview-box').style.display = 'block'; };
                r.readAsDataURL(item.getAsFile());
            }
        });
        function removeImg() { imgBase64 = null; document.getElementById('preview-box').style.display = 'none'; }
        document.getElementById('btnSend').onclick = sendMsg;
        userInput.addEventListener('keypress', e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }});
    </script>
</body>
</html>
