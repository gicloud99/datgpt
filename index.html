<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DatGPT 4.0 - Live Conversation</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');

        :root {
            --bg-body: #020617;
            --accent: #38bdf8;
            --text-primary: #f8fafc;
        }

        body { 
            margin: 0; background: var(--bg-body); color: var(--text-primary); 
            font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; overflow: hidden; 
        }

        #app-container { display: flex; flex-direction: column; height: 100%; max-width: 1000px; margin: 0 auto; }

        /* HEADER */
        header { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .logo { font-weight: 700; font-size: 18px; }

        /* CHAT AREA (Ẩn đi khi bật chế độ Voice) */
        #chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .msg-row { display: flex; gap: 10px; }
        .user { flex-direction: row-reverse; }
        .bubble { max-width: 80%; padding: 10px 15px; border-radius: 15px; background: rgba(255,255,255,0.1); font-size: 15px; }
        .user .bubble { background: var(--accent); color: #000; }

        /* INPUT AREA */
        .input-wrapper { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); background: #0f172a; z-index: 10;}
        .input-box { display: flex; gap: 10px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 20px; }
        input { flex: 1; background: transparent; border: none; color: white; outline: none; }
        .btn { padding: 10px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; }
        .btn-mic { background: rgba(255,255,255,0.1); color: white; }
        .btn-send { background: var(--accent); color: black; }

        /* --- VOICE OVERLAY (GIAO DIỆN GỌI ĐIỆN) --- */
        #voice-overlay {
            position: fixed; inset: 0; background: #0f172a; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.3s ease; transform: translateY(100%);
        }
        #voice-overlay.active { transform: translateY(0); }

        /* Hiệu ứng sóng âm */
        .voice-visualizer {
            width: 150px; height: 150px; border-radius: 50%;
            background: linear-gradient(135deg, #0ea5e9, #6366f1);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(56, 189, 248, 0.5);
            margin-bottom: 50px;
            position: relative;
        }
        
        .voice-visualizer::after {
            content: ''; position: absolute; inset: -20px; border-radius: 50%;
            border: 2px solid var(--accent); opacity: 0;
        }

        .speaking .voice-visualizer { animation: pulse 1.5s infinite; }
        .speaking .voice-visualizer::after { animation: ripple 1.5s infinite; }

        .ai-speaking .voice-visualizer { animation: bounce 1s infinite; background: #22c55e; box-shadow: 0 0 30px #22c55e; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(1.5); opacity: 0; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .status-text { font-size: 18px; color: var(--text-secondary); margin-bottom: 30px; font-weight: 500; }
        
        .btn-hangup {
            background: #ef4444; color: white; padding: 15px 40px; 
            border-radius: 30px; border: none; font-weight: bold; font-size: 16px; cursor: pointer;
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <div class="logo">DatGPT Live</div>
            <div id="user-info" style="font-size: 12px; opacity: 0.7;"></div>
        </header>

        <div id="chat-area">
            </div>

        <div class="input-wrapper">
            <div class="input-box">
                <input type="text" id="user-input" placeholder="Nhập tin nhắn...">
                <button class="btn btn-mic" onclick="startVoiceMode()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
                </button>
                <button class="btn btn-send" onclick="handleSend()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="voice-overlay">
        <div class="voice-visualizer">
            <svg width="50" height="50" fill="white" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
        </div>
        <div id="voice-status" class="status-text">Đang nghe...</div>
        <div id="transcript-preview" style="height: 40px; color: #94a3b8; font-size: 14px; margin-bottom: 20px; text-align: center; padding: 0 20px;"></div>
        <button class="btn-hangup" onclick="endVoiceMode()">Kết thúc cuộc gọi</button>
    </div>

    <script>
        // === CẤU HÌNH ===
        const CONFIG = {
            apiKey: "AIzaSyA7YEavMh6_c2qvvw1oMgChgXwzh-KsFDo", // API Key của bạn
            model: "gemini-2.5-flash-lite", // Model xử lý nội dung
        };

        let currentUser = localStorage.getItem('datgpt_user') || "Bạn";
        let history = [];
        
        // Biến điều khiển Voice
        let recognition;
        let isVoiceActive = false;
        let isAIThinking = false;

        // --- KHỞI TẠO ---
        window.onload = () => {
            if(!localStorage.getItem('datgpt_user')) {
                const name = prompt("Tên bạn là gì?");
                if(name) {
                    currentUser = name;
                    localStorage.setItem('datgpt_user', name);
                }
            }
            document.getElementById('user-info').innerText = `Người dùng: ${currentUser}`;
            setupRecognition();
        };

        // --- LOGIC GỬI TIN NHẮN (API) ---
        async function chatWithGemini(text) {
            // Hiển thị tin nhắn người dùng
            addBubble('user', text);
            
            // Nếu đang voice mode -> Cập nhật trạng thái
            if(isVoiceActive) updateStatus("AI đang suy nghĩ...", false);

            try {
                // System Instruction để AI trả lời ngắn gọn như đang nói chuyện
                const systemPrompt = `Bạn đang trong cuộc trò chuyện bằng giọng nói trực tiếp với ${currentUser}. Hãy trả lời thật ngắn gọn, tự nhiên, như một người bạn (không dùng gạch đầu dòng, không quá 2 câu nếu không cần thiết).`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.model}:generateContent?key=${CONFIG.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [
                            { role: "user", parts: [{ text: "System: " + systemPrompt }] },
                            ...history, 
                            { role: "user", parts: [{ text }] }
                        ]
                    })
                });

                const data = await response.json();
                const reply = data.candidates[0].content.parts[0].text;

                addBubble('ai', reply);
                history.push({ role: "user", parts: [{ text }] });
                history.push({ role: "model", parts: [{ text: reply }] });

                // QUAN TRỌNG: Đọc to câu trả lời
                speak(reply);

            } catch (e) {
                console.error(e);
                if(isVoiceActive) speak("Xin lỗi, tôi bị mất kết nối.");
            }
        }

        // --- LOGIC VOICE (CORE) ---
        function setupRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.lang = 'vi-VN';
                recognition.continuous = false; // Ngắt khi ngừng nói để gửi ngay
                recognition.interimResults = false;

                recognition.onstart = () => {
                    if(isVoiceActive) {
                        updateStatus("Đang nghe bạn nói...", true);
                        document.getElementById('voice-overlay').classList.add('speaking');
                    }
                };

                recognition.onend = () => {
                    document.getElementById('voice-overlay').classList.remove('speaking');
                    // Nếu chế độ Voice đang bật và AI KHÔNG đang suy nghĩ/nói -> Bật lại mic (Loop)
                    // Logic này sẽ được xử lý trong hàm onresult và hàm speak
                };

                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    document.getElementById('transcript-preview').innerText = `"${text}"`;
                    
                    if (isVoiceActive && text.trim()) {
                        chatWithGemini(text); // Gửi đi ngay khi nói xong
                    }
                };
            } else {
                alert("Trình duyệt không hỗ trợ Voice API");
            }
        }

        // --- TEXT TO SPEECH & AUTO RESTART MIC ---
        function speak(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'vi-VN';
            utterance.rate = 1.1;

            // Khi AI bắt đầu nói
            utterance.onstart = () => {
                if(isVoiceActive) {
                    updateStatus("AI đang nói...", false);
                    document.getElementById('voice-overlay').classList.add('ai-speaking');
                }
            };

            // Khi AI nói XONG -> TỰ ĐỘNG BẬT LẠI MIC (Tạo vòng lặp hội thoại)
            utterance.onend = () => {
                document.getElementById('voice-overlay').classList.remove('ai-speaking');
                if (isVoiceActive) {
                    // Chờ 0.5s rồi bật mic lại cho đỡ bị dội âm
                    setTimeout(() => {
                        try { recognition.start(); } catch(e) {} 
                    }, 500);
                }
            };

            window.speechSynthesis.speak(utterance);
        }

        // --- UI CONTROL ---
        function startVoiceMode() {
            isVoiceActive = true;
            document.getElementById('voice-overlay').classList.add('active');
            try { recognition.start(); } catch(e) {}
        }

        function endVoiceMode() {
            isVoiceActive = false;
            window.speechSynthesis.cancel();
            recognition.stop();
            document.getElementById('voice-overlay').classList.remove('active');
        }

        function updateStatus(msg, isUserSpeaking) {
            const el = document.getElementById('voice-status');
            el.innerText = msg;
            el.style.color = isUserSpeaking ? '#38bdf8' : '#22c55e';
        }

        // --- CHAT UI ---
        function handleSend() {
            const input = document.getElementById('user-input');
            if(input.value.trim()) {
                chatWithGemini(input.value);
                input.value = '';
            }
        }

        function addBubble(role, text) {
            const area = document.getElementById('chat-area');
            const row = document.createElement('div');
            row.className = `msg-row ${role}`;
            row.innerHTML = `<div class="bubble">${marked.parse(text)}</div>`;
            area.appendChild(row);
            area.scrollTop = area.scrollHeight;
        }
    </script>
</body>
</html>
