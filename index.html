<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DatGPT 5.0 - Research & Glass UI</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=JetBrains+Mono:wght@400&display=swap');

        :root {
            --bg-color: #0f0f12;
            --glass-bg: rgba(30, 30, 35, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --primary: #00dc82;
            --primary-glow: rgba(0, 220, 130, 0.4);
            --research: #7b61ff;
            --research-glow: rgba(123, 97, 255, 0.4);
            --text: #ececf1;
            --user-msg: linear-gradient(135deg, #00dc82 0%, #00a86b 100%);
            --ai-msg: rgba(255, 255, 255, 0.05);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(0, 220, 130, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(123, 97, 255, 0.08) 0%, transparent 40%);
            color: var(--text);
            font-family: 'Outfit', sans-serif;
            height: 100vh; height: 100dvh;
            overflow: hidden;
            font-size: 15px;
        }

        #app-container {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            position: relative;
        }

        /* HEADER GLASS */
        header {
            padding: 15px 25px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 10;
        }
        .logo-area { display: flex; align-items: center; gap: 10px; }
        .logo-icon { font-size: 20px; }
        .app-title { font-size: 18px; font-weight: 600; background: linear-gradient(to right, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .mode-badge { 
            font-size: 10px; padding: 3px 8px; border-radius: 12px; 
            background: #222; border: 1px solid #444; color: #888; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.3s;
        }
        .mode-badge.active { background: var(--research); color: #fff; border-color: var(--research); box-shadow: 0 0 10px var(--research-glow); }

        /* CHAT AREA */
        #chat-area {
            flex: 1; overflow-y: auto;
            padding: 20px 0;
            display: flex; flex-direction: column; gap: 20px;
            scroll-behavior: smooth;
        }

        .msg-row {
            width: 100%; padding: 0 20px;
            display: flex; flex-direction: column;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .msg-row.user { align-items: flex-end; }
        .msg-row.ai { align-items: flex-start; }

        .msg {
            max-width: 800px; width: fit-content;
            padding: 12px 18px; border-radius: 18px;
            line-height: 1.6; font-size: 15px; position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .msg.user { 
            background: var(--user-msg); 
            color: #fff; 
            border-bottom-right-radius: 4px; 
        }
        
        .msg.ai { 
            background: var(--ai-msg); 
            border: 1px solid var(--glass-border);
            border-bottom-left-radius: 4px;
        }
        .msg.ai.thinking { border-color: var(--research); box-shadow: 0 0 15px rgba(123, 97, 255, 0.1); }

        .role-label { font-size: 11px; margin-bottom: 5px; opacity: 0.6; font-weight: 500; display: block; }
        
        pre { background: rgba(0,0,0,0.3) !important; padding: 15px; border-radius: 10px; overflow-x: auto; margin: 10px 0; border: 1px solid var(--glass-border); }
        code { font-family: 'JetBrains Mono', monospace; font-size: 13px; }
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid #444; }

        /* INPUT AREA GLASS */
        .input-container {
            padding: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid var(--glass-border);
            display: flex; flex-direction: column; align-items: center;
        }

        .input-wrapper { width: 100%; max-width: 900px; }

        /* TOOLS BAR */
        .tools { display: flex; gap: 8px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 5px; align-items: center; }
        .tools::-webkit-scrollbar { height: 0px; }
        
        .pill { 
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: #ccc; 
            padding: 6px 14px; border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; transition: 0.2s; 
            display: flex; align-items: center; gap: 6px;
        }
        .pill:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: #666; }

        /* Toggle Research */
        .research-toggle {
            background: rgba(123, 97, 255, 0.1); border-color: rgba(123, 97, 255, 0.3); color: #a390ff;
        }
        .research-toggle.active {
            background: var(--research); color: white; border-color: var(--research); box-shadow: 0 0 12px var(--research-glow);
        }

        .preview-box { display: none; margin-bottom: 10px; position: relative; width: fit-content; }
        .preview-box img { height: 60px; border-radius: 8px; border: 1px solid #555; }
        .preview-box .close-img { position: absolute; top: -8px; right: -8px; background: #333; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 20px; cursor: pointer; font-size: 12px; border: 1px solid #555; }

        /* INPUT ROW */
        .input-row { 
            display: flex; gap: 12px; align-items: flex-end; width: 100%; 
            background: rgba(0,0,0,0.2); padding: 8px; border-radius: 16px; border: 1px solid var(--glass-border);
            transition: 0.3s;
        }
        .input-row:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0, 220, 130, 0.1); }
        .input-row.research-mode:focus-within { border-color: var(--research); box-shadow: 0 0 0 2px rgba(123, 97, 255, 0.1); }

        textarea {
            flex: 1; background: transparent; border: none; color: #fff;
            padding: 10px; resize: none; height: 24px; max-height: 150px;
            outline: none; font-family: inherit; font-size: 15px; line-height: 1.5;
        }

        button {
            height: 40px; width: 40px; border: none; border-radius: 12px;
            cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; background: transparent; color: #888;
        }
        button:hover { color: #fff; background: rgba(255,255,255,0.1); }
        
        .btn-send { background: var(--primary); color: #000; box-shadow: 0 0 10px var(--primary-glow); }
        .btn-send:hover { background: #00b368; color: #000; transform: scale(1.05); }
        
        /* Ch·∫ø ƒë·ªô Research ƒë·ªïi m√†u n√∫t g·ª≠i */
        .input-row.research-mode .btn-send { background: var(--research); color: #fff; box-shadow: 0 0 10px var(--research-glow); }

        .btn-mic.listening { color: #e74c3c; animation: pulse 1.5s infinite; }

        /* MODAL */
        #settings-modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: #1a1a1e; width: 400px; padding: 30px; border-radius: 20px;
            border: 1px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .input-group input { width: 100%; padding: 12px; background: #2a2a2e; border: 1px solid #444; color: white; border-radius: 8px; margin-top: 5px; outline: none; }
        .input-group input:focus { border-color: var(--primary); }
        .btn-save { width: 100%; background: var(--primary); color: #000; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; margin-top: 15px; }

        /* Mobile */
        @media screen and (max-width: 768px) {
            .msg { max-width: 90%; }
            .modal-box { width: 90%; }
            header { padding: 10px 15px; }
            .input-container { padding: 15px; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <div class="logo-area">
                <span class="logo-icon">ü§ñ</span>
                <div style="display:flex; flex-direction:column; gap:2px;">
                    <span class="app-title">DatGPT 5.0</span>
                    <span class="mode-badge" id="mode-badge">Standard</span>
                </div>
            </div>
            <button onclick="toggleSettings()" title="C√†i ƒë·∫∑t">‚öôÔ∏è</button>
        </header>

        <div id="chat-area">
            <div class="msg-row ai">
                <div class="msg ai">
                    <span class="role-label">AI ASSISTANT</span>
                    üëã <b>Ch√†o b·∫°n!</b><br>
                    T√¥i l√† DatGPT phi√™n b·∫£n giao di·ªán m·ªõi.<br>
                    H√£y th·ª≠ t√≠nh nƒÉng <b>"Deep Research"</b> ƒë·ªÉ nh·∫≠n c√¢u tr·∫£ l·ªùi chuy√™n s√¢u.
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <div class="tools">
                    <span class="pill research-toggle" id="btnResearch" onclick="toggleResearch()">
                        üß† Deep Research <span id="res-status">OFF</span>
                    </span>
                    <span class="pill" onclick="clearChat()">üßπ X√≥a</span>
                    <span class="pill" onclick="setInput('Ph√¢n t√≠ch chi ti·∫øt v·ªÅ: ')">üßê Ph√¢n t√≠ch</span>
                    <span class="pill" onclick="exportChat()">üíæ L∆∞u</span>
                </div>

                <div class="preview-box" id="preview-box">
                    <img id="preview-img" src="">
                    <div class="close-img" onclick="removeImg()">√ó</div>
                </div>

                <div class="input-row" id="input-row-box">
                    <button class="btn-mic" id="btnLive" title="Ch·∫ø ƒë·ªô Live">üéß</button>
                    <button class="btn-mic" id="btnMic" title="Nh·∫≠p gi·ªçng n√≥i">üéôÔ∏è</button>
                    <textarea id="userInput" placeholder="Nh·∫≠p tin nh·∫Øn..." rows="1" oninput="autoResize(this)"></textarea>
                    <button class="btn-send" id="btnSend">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal-box">
            <h3 style="margin-top:0; color:#fff;">C√†i ƒë·∫∑t</h3>
            <div class="input-group">
                <label style="color:#aaa; font-size:13px">T√™n hi·ªÉn th·ªã:</label>
                <input type="text" id="cfgName" placeholder="B·∫°n">
            </div>
            <div class="input-group" style="margin-top:15px">
                <label style="color:#aaa; font-size:13px">Gemini API Key: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--primary); text-decoration:none;">(L·∫•y Key)</a></label>
                <input type="password" id="cfgKey" placeholder="Paste Key v√†o ƒë√¢y...">
            </div>
            <button class="btn-save" onclick="saveSettings()">L∆∞u C·∫•u H√¨nh</button>
            <button onclick="toggleSettings()" style="width:100%; margin-top:10px; background:none; border:none; color:#666; cursor:pointer;">ƒê√≥ng</button>
        </div>
    </div>

    <script>
        // === STATE & CONFIG ===
        const CONFIG = { modelId: "gemini-2.5-flash", historyLimit: 20 };
        let state = {
            apiKey: localStorage.getItem('gpt_key') || "",
            userName: localStorage.getItem('gpt_name') || "B·∫°n",
            history: [],
            isLive: false,
            aiSpeaking: false,
            isResearch: false // Tr·∫°ng th√°i Research
        };

        // DOM Elements
        const chatArea = document.getElementById('chat-area');
        const userInput = document.getElementById('userInput');
        const inputRow = document.getElementById('input-row-box');
        let imgBase64 = null;

        // Init
        marked.setOptions({ breaks: true, highlight: (code) => hljs.highlightAuto(code).value });
        if(!state.apiKey) setTimeout(toggleSettings, 800);

        // === RESEARCH FEATURE ===
        function toggleResearch() {
            state.isResearch = !state.isResearch;
            const btn = document.getElementById('btnResearch');
            const status = document.getElementById('res-status');
            const badge = document.getElementById('mode-badge');

            if(state.isResearch) {
                btn.classList.add('active');
                inputRow.classList.add('research-mode');
                status.innerText = "ON";
                badge.innerText = "Deep Research";
                badge.classList.add('active');
            } else {
                btn.classList.remove('active');
                inputRow.classList.remove('research-mode');
                status.innerText = "OFF";
                badge.innerText = "Standard";
                badge.classList.remove('active');
            }
        }

        // === CORE CHAT ===
        async function sendMsg() {
            const text = userInput.value.trim();
            if(!text && !imgBase64) return;
            if(!state.apiKey) { alert("Vui l√≤ng nh·∫≠p API Key!"); toggleSettings(); return; }

            // UI User
            addMsg('user', text || '[H√¨nh ·∫£nh]', !!imgBase64);
            if(imgBase64) addMsg('user', `<img src="data:image/png;base64,${imgBase64}">`, true);
            
            userInput.value = '';
            userInput.style.height = '24px'; // Reset height
            removeImg();
            
            // UI Loading (Research style)
            const loadingText = state.isResearch ? 'üß† ƒêang nghi√™n c·ª©u s√¢u...' : '...';
            const loadingRow = addMsg('ai', `<span style="color:#888">${loadingText}</span>`, true);
            const loadingDiv = loadingRow.querySelector('.msg');
            if(state.isResearch) loadingDiv.classList.add('thinking');

            // Prompt Engineering cho Research Mode
            let sysInstruct = `B·∫°n l√† tr·ª£ l√Ω AI. T√™n User: ${state.userName}. `;
            if(state.isResearch) {
                sysInstruct += `CH·∫æ ƒê·ªò DEEP RESEARCH ƒê√É B·∫¨T.
                Nhi·ªám v·ª•: Ph√¢n t√≠ch v·∫•n ƒë·ªÅ c·ª±c k·ª≥ chi ti·∫øt, s√¢u s·∫Øc v√† to√†n di·ªán.
                Y√™u c·∫ßu:
                1. Chia c√¢u tr·∫£ l·ªùi th√†nh c√°c ph·∫ßn r√µ r√†ng (Ti√™u ƒë·ªÅ, Lu·∫≠n ƒëi·ªÉm, V√≠ d·ª•, K·∫øt lu·∫≠n).
                2. S·ª≠ d·ª•ng gi·ªçng vƒÉn chuy√™n gia, logic ch·∫∑t ch·∫Ω.
                3. N·∫øu l√† code, h√£y gi·∫£i th√≠ch t·ª´ng d√≤ng quan tr·ªçng v√† t·ªëi ∆∞u h√≥a n√≥.
                4. Cung c·∫•p g√≥c nh√¨n ƒëa chi·ªÅu.`;
            } else {
                sysInstruct += "Tr·∫£ l·ªùi ng·∫Øn g·ªçn, ƒë√∫ng tr·ªçng t√¢m, th√¢n thi·ªán.";
            }

            // Payload
            let contents = state.history.slice(-CONFIG.historyLimit);
            let parts = [];
            if(imgBase64) parts.push({ inlineData: { mimeType: "image/png", data: imgBase64 }});
            parts.push({ text: text || "Ph√¢n t√≠ch ·∫£nh n√†y" });
            contents.push({ role: 'user', parts });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.modelId}:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: contents,
                        systemInstruction: { parts: [{ text: sysInstruct }] }
                    })
                });

                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                
                const reply = data.candidates[0].content.parts[0].text;
                
                loadingDiv.innerHTML = `<span class="role-label">AI ANSWER</span>` + marked.parse(reply);
                loadingDiv.classList.remove('thinking');
                
                // Add Copy Buttons
                loadingDiv.querySelectorAll('pre code').forEach(block => {
                    const btn = document.createElement('button');
                    btn.innerHTML = 'üìã';
                    btn.className = 'copy-btn';
                    btn.style.cssText = 'position:absolute; top:5px; right:5px; width:25px; height:25px; font-size:12px; background:#444; border-radius:4px;';
                    btn.onclick = () => { navigator.clipboard.writeText(block.innerText); };
                    block.parentElement.style.position = 'relative';
                    block.parentElement.appendChild(btn);
                });

                state.history.push({ role: 'user', parts }, { role: 'model', parts: [{ text: reply }] });
                speak(reply);

            } catch (error) {
                loadingDiv.innerHTML = `<span style="color:#ff5555">‚ö†Ô∏è L·ªói: ${error.message}</span>`;
                loadingDiv.classList.remove('thinking');
            }
        }

        function addMsg(role, text, isHtml) {
            const row = document.createElement('div');
            row.className = `msg-row ${role}`;
            
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            
            // Label cho User
            if(role === 'user') div.innerHTML = `<span class="role-label" style="text-align:right">YOU</span>`;
            else div.innerHTML = `<span class="role-label">AI</span>`;

            div.innerHTML += isHtml ? text : marked.parse(text);
            
            row.appendChild(div);
            chatArea.appendChild(row);
            chatArea.scrollTop = chatArea.scrollHeight;
            return row;
        }

        // === UTILS ===
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }
        
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
            if(modal.style.display === 'flex') {
                document.getElementById('cfgName').value = state.userName;
                document.getElementById('cfgKey').value = state.apiKey;
            }
        }

        function saveSettings() {
            const k = document.getElementById('cfgKey').value.trim();
            const n = document.getElementById('cfgName').value.trim();
            if(k) { localStorage.setItem('gpt_key', k); state.apiKey = k; }
            if(n) { localStorage.setItem('gpt_name', n); state.userName = n; }
            toggleSettings();
        }

        function clearChat() { chatArea.innerHTML = ''; state.history = []; }
        function setInput(txt) { userInput.value = txt; userInput.focus(); }
        
        function exportChat() {
            const blob = new Blob([state.history.map(m => `### ${m.role}:\n${m.parts[0].text}`).join('\n\n')], {type: 'text/markdown'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Chat_History.md`; a.click();
        }

        // Image & Paste Logic
        window.addEventListener('paste', e => {
            const item = Array.from(e.clipboardData.items).find(i => i.type.includes('image'));
            if(item) {
                const r = new FileReader();
                r.onload = (ev) => { 
                    imgBase64 = ev.target.result.split(',')[1]; 
                    document.getElementById('preview-img').src = ev.target.result; 
                    document.getElementById('preview-box').style.display = 'block'; 
                };
                r.readAsDataURL(item.getAsFile());
            }
        });
        function removeImg() { imgBase64 = null; document.getElementById('preview-box').style.display = 'none'; }

        // Send triggers
        document.getElementById('btnSend').onclick = sendMsg;
        userInput.addEventListener('keypress', e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }});

        // Voice Logic (Gi·ªØ nguy√™n)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'vi-VN'; recognition.continuous = false;
            recognition.onstart = () => {
                document.getElementById('btnMic').classList.add('listening');
                if(state.isLive) document.getElementById('btnLive').classList.add('listening');
            };
            recognition.onend = () => {
                document.getElementById('btnMic').classList.remove('listening');
                if (state.isLive && !state.aiSpeaking) setTimeout(() => { try { recognition.start(); } catch(e){} }, 500);
            };
            recognition.onresult = (e) => {
                const t = e.results[0][0].transcript;
                if(state.isLive) { userInput.value = t; sendMsg(); } 
                else { userInput.value += (userInput.value ? " " : "") + t; autoResize(userInput); }
            };
        }
        document.getElementById('btnMic').onclick = () => { if(state.isLive) return alert("T·∫Øt ch·∫ø ƒë·ªô Live tr∆∞·ªõc!"); recognition && recognition.start(); };
        document.getElementById('btnLive').onclick = function() {
            if(!recognition) return alert("Kh√¥ng h·ªó tr·ª£ gi·ªçng n√≥i");
            state.isLive = !state.isLive;
            this.style.background = state.isLive ? 'rgba(231, 76, 60, 0.2)' : 'transparent';
            this.style.color = state.isLive ? '#e74c3c' : '#888';
            state.isLive ? recognition.start() : (recognition.stop(), window.speechSynthesis.cancel());
        };

        function speak(text) {
            if(!state.isLive) return;
            window.speechSynthesis.cancel();
            state.aiSpeaking = true; recognition.stop();
            const u = new SpeechSynthesisUtterance(text.replace(/[*#`]/g, '').substring(0, 300));
            u.lang = 'vi-VN';
            u.onend = () => { state.aiSpeaking = false; if(state.isLive) setTimeout(() => recognition.start(), 500); };
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
