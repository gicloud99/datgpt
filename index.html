<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DatGPT 3.0 - Cloud Cloud</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400&display=swap');

        :root {
            --bg-body: #09090b; --bg-panel: #18181b; --border: #27272a;
            --primary: #10a37f; --text-main: #e4e4e7;
        }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; height: 100dvh; overflow: hidden; font-size: 15px; }
        
        /* Layout */
        #app-container { display: flex; flex-direction: column; height: 100%; max-width: 1200px; margin: 0 auto; position: relative; }
        header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .app-name { font-weight: 600; font-size: 16px; color: #fff; display: flex; align-items: center; gap: 10px; }
        .user-info { font-size: 12px; color: #888; background: #222; padding: 4px 8px; border-radius: 4px; }

        /* Chat Area */
        #chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .msg-row { display: flex; width: 100%; gap: 10px; }
        .msg-row.user { justify-content: flex-end; }
        .msg-content { max-width: 800px; padding: 10px 15px; border-radius: 12px; line-height: 1.6; font-size: 15px; word-wrap: break-word; }
        .msg-row.user .msg-content { background: #27272a; color: #fff; }
        .msg-row.ai .msg-content { background: transparent; padding: 0; width: 100%; }
        
        pre { background: #18181b !important; padding: 15px; border-radius: 8px; overflow-x: auto; margin: 10px 0; border: 1px solid #333; }
        code { font-family: 'JetBrains Mono', monospace; font-size: 13px; }
        img { max-width: 100%; border-radius: 8px; margin-top: 5px; }

        /* Input Area */
        .input-container { padding: 20px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
        .input-box { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 8px 12px; display: flex; align-items: flex-end; gap: 10px; }
        textarea { flex: 1; background: transparent; border: none; color: #fff; padding: 10px 0; resize: none; height: 44px; max-height: 150px; font-family: inherit; font-size: 15px; }
        button { width: 36px; height: 36px; border-radius: 8px; border: none; cursor: pointer; background: transparent; color: #888; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        button:hover { background: #333; color: #fff; }
        .btn-send { background: var(--primary) !important; color: #fff !important; }

        /* Login Modal & Settings */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #18181b; width: 400px; padding: 30px; border-radius: 16px; border: 1px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-title { margin-top: 0; color: #fff; text-align: center; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; color: #aaa; font-size: 13px; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 12px; background: #27272a; border: 1px solid #333; color: white; border-radius: 8px; outline: none; transition: 0.2s; }
        .input-group input:focus { border-color: var(--primary); }
        .btn-primary { width: 100%; background: var(--primary); color: white; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .hidden { display: none !important; }
        .error-msg { color: #ef4444; font-size: 13px; text-align: center; margin-top: 10px; min-height: 20px; }
        .loading-spinner { border: 3px solid #333; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="login-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 class="modal-title">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</h2>
            <p style="color:#666; text-align:center; font-size:13px; margin-bottom:20px;">D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c l∆∞u tr√™n GitHub</p>
            
            <div class="input-group">
                <label>T√™n ƒëƒÉng nh·∫≠p (ID):</label>
                <input type="text" id="loginName" placeholder="V√≠ d·ª•: datnguyen123">
            </div>
            
            <div id="password-section" class="input-group hidden">
                <label id="pass-label">M·∫≠t kh·∫©u:</label>
                <input type="password" id="loginPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
            </div>

            <div class="loading-spinner" id="login-spinner"></div>
            <div class="error-msg" id="login-error"></div>

            <button class="btn-primary" id="btnCheckUser" onclick="checkUser()">Ki·ªÉm tra T√™n</button>
            <button class="btn-primary hidden" id="btnLoginAction" onclick="performLogin()">X√°c nh·∫≠n</button>
            
            <div style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">
                <button onclick="toggleSettings()" style="width:100%; font-size:12px; color:#666; height:auto;">C·∫•u h√¨nh GitHub Token</button>
            </div>
        </div>
    </div>

    <div id="app-container">
        <header>
            <div class="app-name">
                <span style="width:10px;height:10px;background:#10a37f;border-radius:50%"></span>
                DatGPT 3.0 Cloud
            </div>
            <div class="user-info" id="display-user">Ch∆∞a ƒëƒÉng nh·∫≠p</div>
        </header>

        <div id="chat-area"></div>

        <div class="input-container">
            <div class="input-box">
                <input type="file" id="fileInput" accept="image/*" style="display:none">
                <button onclick="document.getElementById('fileInput').click()">üñºÔ∏è</button>
                <textarea id="userInput" placeholder="Nh·∫≠p tin nh·∫Øn..." rows="1"></textarea>
                <button class="btn-send" id="btnSend">‚û§</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3 class="modal-title">C·∫•u h√¨nh H·ªá th·ªëng</h3>
            <div class="input-group">
                <label>Gemini API Key:</label>
                <input type="password" id="cfgKey">
            </div>
            <div class="input-group">
                <label>GitHub Token (Repo scope):</label>
                <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx">
            </div>
            <div class="input-group">
                <label>GitHub Username (Owner):</label>
                <input type="text" id="ghOwner" placeholder="T√™n user github c·ªßa b·∫°n">
            </div>
            <div class="input-group">
                <label>Repo Name:</label>
                <input type="text" id="ghRepo" placeholder="T√™n repo (vd: chat-data)">
            </div>
            <button class="btn-primary" onclick="saveSettings()">L∆∞u C·∫•u H√¨nh</button>
            <button onclick="toggleSettings()" style="width:100%; margin-top:10px; color:#888;">ƒê√≥ng</button>
        </div>
    </div>

    <script>
        // === CONFIGURATION ===
        const CONFIG = {
            modelId: "gemini-2.5-flash",
            historyLimit: 100 // Gi·ªõi h·∫°n 100 tin nh·∫Øn
        };

        let state = {
            apiKey: localStorage.getItem('gpt_key') || "",
            ghToken: localStorage.getItem('gh_token') || "",
            ghOwner: localStorage.getItem('gh_owner') || "",
            ghRepo: localStorage.getItem('gh_repo') || "",
            
            currentUser: null,
            currentSha: null, // SHA c·ªßa file json tr√™n github (ƒë·ªÉ update)
            history: []
        };

        // === GITHUB SERVICE ===
        const GitHub = {
            // Helper ƒë·ªÉ encode/decode Unicode sang Base64
            utf8_to_b64: (str) => window.btoa(unescape(encodeURIComponent(str))),
            b64_to_utf8: (str) => decodeURIComponent(escape(window.atob(str))),

            async getFile(filename) {
                if(!state.ghToken) return { error: "Ch∆∞a c√≥ GitHub Token" };
                const url = `https://api.github.com/repos/${state.ghOwner}/${state.ghRepo}/contents/users/${filename}`;
                
                try {
                    const res = await fetch(url, {
                        headers: { 
                            'Authorization': `token ${state.ghToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if(res.status === 404) return { status: 404 }; // Ch∆∞a c√≥ file
                    if(!res.ok) throw new Error("L·ªói k·∫øt n·ªëi GitHub");
                    
                    const data = await res.json();
                    const content = JSON.parse(this.b64_to_utf8(data.content));
                    return { status: 200, sha: data.sha, content: content };
                } catch (e) {
                    return { error: e.message };
                }
            },

            async saveFile(filename, content, sha = null) {
                const url = `https://api.github.com/repos/${state.ghOwner}/${state.ghRepo}/contents/users/${filename}`;
                const body = {
                    message: "Update chat history",
                    content: this.utf8_to_b64(JSON.stringify(content, null, 2))
                };
                if(sha) body.sha = sha;

                await fetch(url, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `token ${state.ghToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
            }
        };

        // === APP LOGIC ===
        
        // 1. Ki·ªÉm tra User khi ƒëƒÉng nh·∫≠p
        async function checkUser() {
            const name = document.getElementById('loginName').value.trim();
            const errorDiv = document.getElementById('login-error');
            const spinner = document.getElementById('login-spinner');
            
            if(!name) return errorDiv.innerText = "Vui l√≤ng nh·∫≠p t√™n!";
            if(!state.ghToken) return errorDiv.innerText = "Vui l√≤ng c·∫•u h√¨nh GitHub Token tr∆∞·ªõc!";

            spinner.style.display = 'block';
            errorDiv.innerText = "";
            
            const res = await GitHub.getFile(`${name}.json`);
            spinner.style.display = 'none';

            if(res.error) {
                alert("L·ªói: " + res.error + ". H√£y ki·ªÉm tra c·∫•u h√¨nh.");
                return toggleSettings();
            }

            // Hi·ªÉn th·ªã ph·∫ßn nh·∫≠p pass
            document.getElementById('btnCheckUser').classList.add('hidden');
            document.getElementById('btnLoginAction').classList.remove('hidden');
            document.getElementById('password-section').classList.remove('hidden');
            document.getElementById('loginName').disabled = true;

            if(res.status === 404) {
                // User m·ªõi
                document.getElementById('pass-label').innerText = "T·∫°o m·∫≠t kh·∫©u m·ªõi:";
                state.isNewUser = true;
            } else {
                // User c≈©
                document.getElementById('pass-label').innerText = "Nh·∫≠p m·∫≠t kh·∫©u:";
                state.isNewUser = false;
                state.serverData = res.content;
                state.currentSha = res.sha;
            }
        }

        // 2. X·ª≠ l√Ω ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω
        async function performLogin() {
            const name = document.getElementById('loginName').value.trim();
            const pass = document.getElementById('loginPass').value.trim();
            const spinner = document.getElementById('login-spinner');
            const errorDiv = document.getElementById('login-error');

            if(!pass) return errorDiv.innerText = "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!";
            spinner.style.display = 'block';

            if(state.isNewUser) {
                // ƒêƒÉng k√Ω: T·∫°o file m·ªõi
                const newData = { password: pass, history: [] };
                try {
                    await GitHub.saveFile(`${name}.json`, newData);
                    // L·∫•y l·∫°i SHA sau khi t·∫°o
                    const check = await GitHub.getFile(`${name}.json`);
                    state.currentSha = check.sha;
                    state.history = [];
                    loginSuccess(name);
                } catch(e) {
                    errorDiv.innerText = "Kh√¥ng th·ªÉ t·∫°o file tr√™n GitHub.";
                }
            } else {
                // ƒêƒÉng nh·∫≠p: Check pass
                if(state.serverData.password === pass) {
                    state.history = state.serverData.history || [];
                    loginSuccess(name);
                } else {
                    spinner.style.display = 'none';
                    errorDiv.innerText = "Sai m·∫≠t kh·∫©u!";
                }
            }
        }

        function loginSuccess(name) {
            state.currentUser = name;
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('display-user').innerText = `User: ${name}`;
            renderHistory();
        }

        // 3. Render L·ªãch s·ª≠ chat
        function renderHistory() {
            const chatArea = document.getElementById('chat-area');
            chatArea.innerHTML = '';
            state.history.forEach(msg => {
                const div = document.createElement('div');
                div.className = `msg-row ${msg.role}`;
                div.innerHTML = `<div class="msg-content">${marked.parse(msg.parts[0].text)}</div>`;
                chatArea.appendChild(div);
            });
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // 4. G·ª≠i tin nh·∫Øn & L∆∞u Cloud
        async function sendMsg() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if(!text) return;
            if(!state.apiKey) return alert("Thi·∫øu Gemini API Key!");

            // UI
            input.value = '';
            appendMsg('user', text);
            
            // Logic
            const payload = {
                contents: [
                    ...state.history.map(h => ({ role: h.role, parts: h.parts })),
                    { role: 'user', parts: [{ text: text }] }
                ]
            };

            const loadingId = appendMsg('ai', '...');

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.modelId}:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;

                // X√≥a loading, hi·ªán k·∫øt qu·∫£
                document.getElementById(loadingId).innerHTML = marked.parse(reply);

                // C·∫≠p nh·∫≠t State
                state.history.push(
                    { role: 'user', parts: [{ text: text }] },
                    { role: 'model', parts: [{ text: reply }] }
                );

                // GI·ªöI H·∫†N 100 TIN
                if(state.history.length > CONFIG.historyLimit) {
                    state.history = state.history.slice(state.history.length - CONFIG.historyLimit);
                }

                // L∆ØU L√äN GITHUB (Background save)
                saveToCloud();

            } catch(e) {
                document.getElementById(loadingId).innerText = "L·ªói: " + e.message;
            }
        }

        async function saveToCloud() {
            if(!state.currentUser) return;
            const dataToSave = {
                password: state.serverData ? state.serverData.password : document.getElementById('loginPass').value,
                history: state.history
            };
            // L∆∞u v√† c·∫≠p nh·∫≠t l·∫°i SHA m·ªõi ƒë·ªÉ l·∫ßn sau kh√¥ng l·ªói
            await GitHub.saveFile(`${state.currentUser}.json`, dataToSave, state.currentSha);
            // L·∫•y l·∫°i SHA m·ªõi nh·∫•t (Best practice ƒë·ªÉ tr√°nh conflict)
            const updated = await GitHub.getFile(`${state.currentUser}.json`);
            if(updated.sha) state.currentSha = updated.sha;
        }

        function appendMsg(role, text) {
            const id = 'msg-' + Date.now();
            const chatArea = document.getElementById('chat-area');
            const div = document.createElement('div');
            div.className = `msg-row ${role === 'user' ? 'user' : 'ai'}`;
            div.innerHTML = `<div class="msg-content" id="${id}">${role==='ai' && text==='...' ? '...' : marked.parse(text)}</div>`;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
            return id;
        }

        // Settings Logic
        function toggleSettings() {
            const m = document.getElementById('settings-modal');
            m.classList.toggle('hidden');
            if(!m.classList.contains('hidden')) {
                document.getElementById('cfgKey').value = state.apiKey;
                document.getElementById('ghToken').value = state.ghToken;
                document.getElementById('ghOwner').value = state.ghOwner;
                document.getElementById('ghRepo').value = state.ghRepo;
            }
        }

        function saveSettings() {
            state.apiKey = document.getElementById('cfgKey').value.trim();
            state.ghToken = document.getElementById('ghToken').value.trim();
            state.ghOwner = document.getElementById('ghOwner').value.trim();
            state.ghRepo = document.getElementById('ghRepo').value.trim();

            localStorage.setItem('gpt_key', state.apiKey);
            localStorage.setItem('gh_token', state.ghToken);
            localStorage.setItem('gh_owner', state.ghOwner);
            localStorage.setItem('gh_repo', state.ghRepo);
            
            toggleSettings();
            alert("ƒê√£ l∆∞u c·∫•u h√¨nh! H√£y th·ª≠ ƒëƒÉng nh·∫≠p l·∫°i.");
        }

        document.getElementById('btnSend').onclick = sendMsg;
    </script>
</body>
</html>
