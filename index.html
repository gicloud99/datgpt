<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DatGPT 4.0</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400&display=swap');

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background-color: #1e1e1e; /* M√†u n·ªÅn tr√πng m√†u app */
            color: #eee;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            height: 100dvh; /* H·ªó tr·ª£ mobile browser m·ªõi */
            overflow: hidden; /* NgƒÉn cu·ªôn trang ngo√†i */
        }

        /* Container ch√≠nh FULL M√ÄN H√åNH */
        #app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            position: relative;
        }

        /* Header */
        header {
            padding: 15px 30px;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .app-title { font-size: 18px; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 10px; }
        .status-dot { width: 10px; height: 10px; background: #00ff88; border-radius: 50%; box-shadow: 0 0 8px #00ff88; }
        .live-badge { font-size: 11px; background: #e74c3c; color: white; padding: 2px 6px; border-radius: 4px; display: none; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.6; } }

        /* V√πng Chat */
        #chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0; /* Padding tr√™n d∆∞·ªõi */
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
            align-items: center; /* CƒÉn gi·ªØa c√°c tin nh·∫Øn */
        }

        /* Row ch·ª©a tin nh·∫Øn ƒë·ªÉ ki·ªÉm so√°t ƒë·ªô r·ªông */
        .msg-row {
            width: 100%;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
        }
        .msg-row.user { align-items: flex-end; }
        .msg-row.ai { align-items: flex-start; }

        .msg {
            max-width: 800px; /* Gi·ªõi h·∫°n ƒë·ªô r·ªông t·ªëi ƒëa ƒë·ªÉ d·ªÖ ƒë·ªçc tr√™n m√†n to */
            width: fit-content;
            padding: 12px 20px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 16px;
            word-wrap: break-word;
            position: relative;
        }
        
        .msg.user { background: #10a37f; color: #fff; border-bottom-right-radius: 2px; }
        .msg.ai { background: #2f2f2f; border: 1px solid #444; border-bottom-left-radius: 2px; width: 100%; max-width: 800px; }
        
        /* Code block */
        pre { background: #111 !important; padding: 15px; border-radius: 8px; overflow-x: auto; margin: 10px 0; border: 1px solid #444; }
        code { font-family: 'JetBrains Mono', monospace; font-size: 14px; }
        .msg img { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; border: 1px solid #555; }

        /* Input Area */
        .input-container {
            padding: 20px;
            background: #1e1e1e;
            border-top: 1px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center; /* CƒÉn gi·ªØa v√πng nh·∫≠p li·ªáu */
            flex-shrink: 0;
        }

        .input-wrapper {
            width: 100%;
            max-width: 900px; /* Gi·ªõi h·∫°n ƒë·ªô r·ªông v√πng nh·∫≠p li·ªáu */
        }
        
        .preview-box { display: none; margin-bottom: 10px; }
        .preview-box img { height: 60px; border-radius: 6px; border: 1px solid #555; }
        .preview-box span { color: #ff5555; cursor: pointer; font-size: 20px; margin-left: 10px; vertical-align: top; }

        .input-row { display: flex; gap: 15px; align-items: flex-end; width: 100%; }
        
        textarea {
            flex: 1;
            background: #2a2a2a;
            border: 1px solid #444;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            resize: none;
            height: 55px;
            outline: none;
            font-family: inherit;
            font-size: 15px;
            transition: 0.2s;
        }
        textarea:focus { border-color: #10a37f; background: #252525; }

        button {
            height: 55px; width: 55px;
            border: none; border-radius: 8px;
            cursor: pointer; font-size: 20px;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
            flex-shrink: 0;
        }
        .btn-mic { background: #333; color: #fff; border: 1px solid #444; }
        .btn-mic:hover { background: #444; }
        .btn-mic.listening { background: #e74c3c; border-color: #c0392b; animation: pulse 1.5s infinite; }
        
        .btn-send { background: #10a37f; color: white; }
        .btn-send:hover { background: #0e8c6d; }

        /* Tools */
        .tools { display: flex; gap: 10px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; width: 100%; justify-content: flex-start; }
        .tools::-webkit-scrollbar { height: 4px; }
        .pill { background: #2a2a2a; border: 1px solid #333; color: #ccc; padding: 6px 14px; border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .pill:hover { border-color: #10a37f; color: #fff; background: #333; }

        /* Settings Modal */
        #settings-modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        .modal-box {
            background: #222; width: 400px; max-width: 100%; padding: 25px; border-radius: 12px;
            border: 1px solid #444; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .modal-title { margin-top: 0; color: #fff; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; color: #aaa; font-size: 13px; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: white; border-radius: 6px; }
        .btn-save { width: 100%; background: #10a37f; color: white; padding: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }

        /* Animation */
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* === MOBILE RESPONSIVE === */
        @media screen and (max-width: 768px) {
            header { padding: 10px 15px; }
            .app-title { font-size: 16px; }
            
            #chat-area { padding: 10px 0; }
            .msg-row { padding: 0 10px; }
            .msg { max-width: 100%; font-size: 15px; padding: 10px 14px; }
            
            .input-container { padding: 10px; }
            .input-row { gap: 8px; }
            
            button { width: 45px; height: 45px; font-size: 18px; }
            textarea { height: 45px; padding: 12px; font-size: 14px; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <div class="app-title">
                <span class="status-dot"></span> 
                DatGPT Ultimate
                <span class="live-badge" id="live-badge">‚óè LIVE VOICE</span>
            </div>
            <div>
                <button onclick="toggleSettings()" style="width:auto; height:auto; background:none; border:none; color:#aaa; font-size:14px; padding:5px; cursor:pointer">‚öôÔ∏è C√†i ƒë·∫∑t</button>
            </div>
        </header>

        <div id="chat-area">
            <div class="msg-row ai">
                <div class="msg ai">
                    üëã <b>Ch√†o m·ª´ng tr·ªü l·∫°i!</b><br>
                    Giao di·ªán hi·ªán t·∫°i ƒë√£ <b>Full M√†n H√¨nh</b>.<br>
                    T√¥i s·∫µn s√†ng h·ªó tr·ª£ b·∫°n vi·∫øt code, d·ªãch thu·∫≠t v√† ph√¢n t√≠ch h√¨nh ·∫£nh.
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <div class="tools">
                    <span class="pill" onclick="clearChat()">üßπ X√≥a Chat</span>
                    <span class="pill" onclick="setInput('Vi·∫øt code Python gi·∫£i ph∆∞∆°ng tr√¨nh b·∫≠c 2')">üêç Code Python</span>
                    <span class="pill" onclick="setInput('D·ªãch sang ti·∫øng Anh: ')">üá∫üá∏ D·ªãch Anh</span>
                    <span class="pill" onclick="exportChat()">üíæ L∆∞u Chat</span>
                </div>

                <div class="preview-box" id="preview-box">
                    <img id="preview-img" src="">
                    <span onclick="removeImg()">√ó</span>
                </div>

                <div class="input-row">
                    <button class="btn-mic" id="btnLive" title="Ch·∫ø ƒë·ªô H·ªôi tho·∫°i li√™n t·ª•c">üéß</button>
                    <button class="btn-mic" id="btnMic" title="Nh·∫≠p gi·ªçng n√≥i">üéôÔ∏è</button>
                    <textarea id="userInput" placeholder="Nh·∫≠p tin nh·∫Øn... (Enter ƒë·ªÉ g·ª≠i)"></textarea>
                    <button class="btn-send" id="btnSend">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal-box">
            <h3 class="modal-title">C√†i ƒë·∫∑t h·ªá th·ªëng</h3>
            <div class="input-group">
                <label>T√™n hi·ªÉn th·ªã:</label>
                <input type="text" id="cfgName" placeholder="V√≠ d·ª•: ƒê·∫°t">
            </div>
            <div class="input-group">
                <label>Gemini API Key (B·∫Øt bu·ªôc):</label>
                <input type="password" id="cfgKey" placeholder="D√°n API Key t·ª´ Google AI Studio v√†o ƒë√¢y...">
            </div>
            <button class="btn-save" onclick="saveSettings()">L∆∞u c·∫•u h√¨nh</button>
            <button onclick="toggleSettings()" style="width:100%; margin-top:10px; background:none; border:none; color:#888; cursor:pointer;">ƒê√≥ng</button>
        </div>
    </div>

    <script>
        // === C·∫§U H√åNH & TR·∫†NG TH√ÅI ===
        const CONFIG = { modelId: "gemini-2.5-flash", historyLimit: 20 }; // D√πng model m·ªõi nh·∫•t
        let state = {
            apiKey: localStorage.getItem('gpt_key') || "",
            userName: localStorage.getItem('gpt_name') || "B·∫°n",
            history: [],
            isLive: false,
            aiSpeaking: false
        };

        const chatArea = document.getElementById('chat-area');
        const userInput = document.getElementById('userInput');
        let imgBase64 = null;

        // C√†i ƒë·∫∑t Markdown
        marked.setOptions({ breaks: true, highlight: (code) => hljs.highlightAuto(code).value });
        
        // Ki·ªÉm tra Key khi m·ªü
        if(!state.apiKey) setTimeout(toggleSettings, 800);

        // === CH·ª®C NƒÇNG CH√çNH ===
        
        async function sendMsg() {
            const text = userInput.value.trim();
            if(!text && !imgBase64) return;
            if(!state.apiKey) { alert("Vui l√≤ng nh·∫≠p API Key!"); toggleSettings(); return; }

            // Hi·ªÉn th·ªã tin nh·∫Øn User
            addMsg('user', text || '[G·ª≠i h√¨nh ·∫£nh]', !!imgBase64);
            if(imgBase64) addMsg('user', `<img src="data:image/png;base64,${imgBase64}">`, true);
            
            // X√≥a input
            userInput.value = '';
            removeImg();
            
            // Hi·ªÉn th·ªã Loading
            const loadingRow = addMsg('ai', '<span style="color:#888">ƒêang suy nghƒ©...</span>', true);
            const loadingDiv = loadingRow.querySelector('.msg');

            // Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i
            let contents = state.history.slice(-CONFIG.historyLimit);
            let parts = [];
            if(imgBase64) parts.push({ inlineData: { mimeType: "image/png", data: imgBase64 }});
            parts.push({ text: text || "M√¥ t·∫£ h√¨nh ·∫£nh n√†y" });
            contents.push({ role: 'user', parts });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.modelId}:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: contents,
                        systemInstruction: { parts: [{ text: `B·∫°n l√† DatGPT, tr·ª£ l√Ω l·∫≠p tr√¨nh v√† h·ªçc t·∫≠p. T√™n User: ${state.userName}. Tr·∫£ l·ªùi ng·∫Øn g·ªçn, ch√≠nh x√°c. Format code ƒë·∫πp.` }] }
                    })
                });

                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                
                const reply = data.candidates[0].content.parts[0].text;
                
                // Render k·∫øt qu·∫£
                loadingDiv.innerHTML = marked.parse(reply);
                
                // Th√™m n√∫t Copy cho Code
                loadingDiv.querySelectorAll('pre code').forEach(block => {
                    block.parentElement.style.position = 'relative';
                    const btn = document.createElement('button');
                    btn.innerText = 'Copy';
                    btn.style.cssText = 'position:absolute; top:5px; right:5px; background:#444; color:#fff; font-size:10px; padding:3px 8px; height:auto; width:auto; border-radius:4px; margin:0;';
                    btn.onclick = () => { navigator.clipboard.writeText(block.innerText); btn.innerText = 'ƒê√£ ch√©p!'; setTimeout(()=>btn.innerText='Copy',1500); };
                    block.parentElement.appendChild(btn);
                });

                // L∆∞u l·ªãch s·ª≠
                state.history.push({ role: 'user', parts }, { role: 'model', parts: [{ text: reply }] });
                
                // ƒê·ªçc gi·ªçng n√≥i
                speak(reply);

            } catch (error) {
                loadingDiv.innerHTML = `<span style="color:#ff5555">‚ö†Ô∏è L·ªói: ${error.message}</span>`;
                state.aiSpeaking = false;
            }
        }

        function addMsg(role, text, isHtml) {
            const row = document.createElement('div');
            row.className = `msg-row ${role}`;
            
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = isHtml ? text : marked.parse(text);
            
            row.appendChild(div);
            chatArea.appendChild(row);
            chatArea.scrollTop = chatArea.scrollHeight;
            return row;
        }

        // === C√ÄI ƒê·∫∂T ===
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
            if(modal.style.display === 'flex') {
                document.getElementById('cfgName').value = state.userName;
                document.getElementById('cfgKey').value = state.apiKey;
            }
        }

        function saveSettings() {
            const k = document.getElementById('cfgKey').value.trim();
            const n = document.getElementById('cfgName').value.trim();
            if(k) { localStorage.setItem('gpt_key', k); state.apiKey = k; }
            if(n) { localStorage.setItem('gpt_name', n); state.userName = n; }
            alert('ƒê√£ l∆∞u c√†i ƒë·∫∑t th√†nh c√¥ng!'); toggleSettings();
        }

        // === GI·ªåNG N√ìI (Web Speech API) ===
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'vi-VN'; 
            recognition.continuous = false;
            
            recognition.onstart = () => {
                document.getElementById('btnMic').classList.add('listening');
                if(state.isLive) document.getElementById('btnLive').classList.add('listening');
            };
            
            recognition.onend = () => {
                document.getElementById('btnMic').classList.remove('listening');
                if (state.isLive && !state.aiSpeaking) {
                    setTimeout(() => { try { recognition.start(); } catch(e){} }, 500);
                }
            };

            recognition.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                if(state.isLive) {
                    userInput.value = transcript;
                    sendMsg();
                } else {
                    userInput.value += (userInput.value ? " " : "") + transcript;
                }
            };
        }

        document.getElementById('btnMic').onclick = () => {
            if(state.isLive) return alert("ƒêang ·ªü ch·∫ø ƒë·ªô Live (T·ª± ƒë·ªông)!");
            recognition && recognition.start();
        };

        document.getElementById('btnLive').onclick = function() {
            if(!recognition) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ gi·ªçng n√≥i");
            state.isLive = !state.isLive;
            const badge = document.getElementById('live-badge');
            if(state.isLive) {
                this.style.background = '#e74c3c';
                badge.style.display = 'inline-block';
                recognition.start();
            } else {
                this.style.background = '#333';
                badge.style.display = 'none';
                recognition.stop();
                window.speechSynthesis.cancel();
            }
        };

        function speak(text) {
            if(!state.isLive) return;
            window.speechSynthesis.cancel();
            state.aiSpeaking = true;
            recognition.stop();
            
            // L·ªçc b·ªè k√Ω t·ª± ƒë·∫∑c bi·ªát ƒë·ªÉ ƒë·ªçc t·ª± nhi√™n h∆°n
            const cleanText = text.replace(/[*#`]/g, '').substring(0, 300);
            const u = new SpeechSynthesisUtterance(cleanText);
            u.lang = 'vi-VN';
            
            u.onend = () => {
                state.aiSpeaking = false;
                if(state.isLive) setTimeout(() => recognition.start(), 500);
            };
            window.speechSynthesis.speak(u);
        }

        // === TI·ªÜN √çCH KH√ÅC ===
        function clearChat() { chatArea.innerHTML = ''; state.history = []; }
        function setInput(txt) { userInput.value = txt; userInput.focus(); }
        
        function exportChat() {
            const content = state.history.map(m => `### ${m.role}:\n${m.parts[0].text}`).join('\n\n---\n\n');
            const blob = new Blob([content], {type: 'text/markdown'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `DatGPT_Export.md`; a.click();
        }

        // X·ª≠ l√Ω d√°n ·∫£nh (Ctrl+V)
        window.addEventListener('paste', e => {
            const item = Array.from(e.clipboardData.items).find(i => i.type.includes('image'));
            if(item) {
                const r = new FileReader();
                r.onload = (ev) => {
                    imgBase64 = ev.target.result.split(',')[1];
                    document.getElementById('preview-img').src = ev.target.result;
                    document.getElementById('preview-box').style.display = 'block';
                };
                r.readAsDataURL(item.getAsFile());
            }
        });

        function removeImg() {
            imgBase64 = null;
            document.getElementById('preview-box').style.display = 'none';
        }

        document.getElementById('btnSend').onclick = sendMsg;
        userInput.addEventListener('keypress', e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }});
    </script>
</body>
</html>
